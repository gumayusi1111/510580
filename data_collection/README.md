# ETF 数据收集系统

🚀 模块化的ETF数据管理系统，支持增量更新、多ETF管理和交互式操作。

## ✨ 功能特性

- 🔄 **增量更新** - 自动更新所有已存在的ETF到最新日期
- ➕ **添加新ETF** - 支持添加新ETF代码并获取全部历史数据  
- 🗑️ **删除ETF** - 完全删除指定ETF的所有相关数据
- 📊 **状态查看** - 查看所有ETF的状态和统计信息
- 🏗️ **模块化设计** - 高内聚低耦合，易于维护和扩展

## 📁 项目结构

```
data_collection/
├── config/                 # 配置模块
│   ├── __init__.py
│   └── settings.py         # 系统配置 (Token、ETF设置等)
├── src/                    # 核心功能模块
│   ├── __init__.py
│   ├── api_client.py       # Tushare API客户端 (89行)
│   ├── data_processor.py   # 数据处理器 (161行)
│   ├── etf_discovery.py    # ETF发现与验证 (96行)
│   ├── etf_updater.py      # 数据更新逻辑 (111行)
│   ├── etf_operations.py   # 高级ETF操作 (131行)
│   └── interactive_menu.py # 交互式菜单 (149行)
├── data/                   # 数据存储目录
│   └── 510580/            # ETF代码目录
│       ├── basic_data.csv  # 基础数据+复权因子
│       ├── raw_data.csv    # 原始交易数据
│       ├── hfq_data.csv    # 后复权数据
│       └── qfq_data.csv    # 前复权数据
├── etf_manager.py          # 系统编排器 (47行)
└── run.py                  # 启动脚本 (15行)
```

## 🎯 设计原则

- **单一职责原则** - 每个模块只负责一个明确的功能
- **高内聚低耦合** - 相关功能集中，模块间依赖最小化
- **可扩展性** - 易于添加新功能和新ETF代码
- **代码简洁** - 每个文件控制在100行左右，便于维护

## 🚀 快速开始

### 1. 启动系统

```bash
python run.py
```

系统会自动检查Token有效性：

**Token有效时**直接启动：
```
🚀 启动ETF数据管理系统...
🔍 验证现有Token...
✅ Token验证成功
```

**Token无效时**自动引导设置：
```
🚀 启动ETF数据管理系统...
🔍 验证现有Token...
❌ 现有Token无效: Token格式无效
🔑 需要设置新的Token

🔑 Tushare Token设置
========================================
💡 如何获取Token:
   1. 访问 https://tushare.pro
   2. 注册并登录账号
   3. 在用户中心找到接口TOKEN
========================================
是否隐藏Token输入? (y/N): 
```

### 2. 交互式操作

系统会显示菜单，选择相应操作：

```
📋 请选择操作:
1️⃣  更新所有ETF到最新 (增量更新)
2️⃣  添加新的ETF代码
3️⃣  删除ETF数据
4️⃣  查看所有ETF状态
0️⃣  退出程序
```

## 📊 数据文件说明

每个ETF代码会在`data/`目录下创建独立文件夹，包含4种数据文件：

- **basic_data.csv** - 基础数据 + 复权因子（完整信息）
- **raw_data.csv** - 除权数据（原始交易价格）  
- **hfq_data.csv** - 后复权数据（量化回测推荐）
- **qfq_data.csv** - 前复权数据（当前价位分析）

## 🔧 核心模块说明

### Token管理器 (`token_manager.py`)
- 自动验证Token有效性
- 交互式Token输入和保存
- 支持隐藏输入保护隐私

### API客户端 (`api_client.py`)
- 管理Tushare API连接
- 提供重试机制和错误处理
- 获取ETF日线数据和复权因子

### 数据处理器 (`data_processor.py`)
- 数据合并和复权计算
- 文件路径管理
- 数据格式整理和保存

### ETF发现器 (`etf_discovery.py`)
- 发现现有ETF代码
- 验证ETF代码格式
- 获取ETF统计信息

### ETF更新器 (`etf_updater.py`)
- 增量更新逻辑
- 日期范围计算
- 数据获取和处理编排

### ETF操作器 (`etf_operations.py`)
- 批量更新所有ETF
- 添加和删除ETF
- 状态显示和摘要

### 交互菜单 (`interactive_menu.py`)
- 用户界面交互
- 菜单显示和选择处理
- 操作结果反馈

## 🛠️ 系统要求

- Python 3.7+
- pandas
- tushare
- 有效的Tushare Token

## 📈 使用示例

### 添加新ETF
选择选项2，输入ETF代码（如`159915`或`159915.SZ`），系统会自动获取全部历史数据。

### 增量更新
选择选项1，系统会检查所有已存在的ETF，只获取最新日期之后的数据。

### 删除ETF
选择选项3，输入要删除的ETF代码，确认后会删除该ETF的所有相关文件。

## 🔄 更新策略

- **首次获取** - 获取ETF从2009年开始的全部历史数据
- **增量更新** - 只获取最新日期之后的新数据，提高效率
- **智能合并** - 自动去重和排序，确保数据完整性

## 🔑 Token安全特性

- **自动验证** - 启动时自动检查Token有效性
- **交互式输入** - Token无效时自动引导用户输入
- **格式验证** - 检查Token长度和格式
- **API测试** - 实际调用API验证权限
- **错误识别** - 区分Token无效、积分不足等不同错误
- **隐私保护** - 支持隐藏输入避免Token泄露
- **自动保存** - 可选择保存到配置文件便于下次使用

## 📝 注意事项

1. **无需手动配置** - 系统会自动处理Token验证和输入
2. 网络连接稳定，API调用有频率限制  
3. 数据文件会自动备份，删除操作需要确认
4. 建议定期运行增量更新保持数据最新
5. 首次使用需要有效的Tushare账号和Token

---

🎉 **现在你可以高效管理多个ETF的数据收集了！**